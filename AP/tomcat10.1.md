# Apache Tomcat 9.0.93 から 10.1.41 への移行影響調査

## 1. 9.0.x 系と 10.1.x 系の主な変更点

### 仕様（Java/Jakarta EE）およびプラットフォームの変更

* **Jakarta EE への移行**: Tomcat 10.1.x は Jakarta EE 10 プラットフォームの仕様（Servlet 6.0、JSP 3.1 など）を実装しており、Tomcat 9.0.x が対応していた Java EE 8（Servlet 4.0、JSP 2.3 など）から大きく更新されています。これに伴い**サーブレット API 等のパッケージが `javax.*` から `jakarta.*` に変更**されています（例えば `javax.servlet` は `jakarta.servlet` へ）。アプリケーションのソースコードやデプロイメント記述子（web.xml など）でこれらパッケージ名・XMLネームスペースの変更に対応が必要ですが、**本調査ではアプリケーション側の修正（javax→jakarta）については対象外**とします。

* **Java 実行環境の要件**: Tomcat 9.0.x は Java SE 8 以上で動作しましたが、Tomcat 10.1.x は **最低でも Java SE 11** が必要です。したがって移行にあたっては運用Javaバージョンの引き上げが必須となります。Java 11+ 環境では TLS1.3 等の新しいプロトコルや機能が利用可能になるため、Tomcat の SSL/TLS 動作やHTTP/2サポートにも影響があります（例えば **HTTP/2 サポートは Java 11 環境でネイティブライブラリ無しに利用可能**）。

* **内部実装と付属ライブラリ**: Tomcat 10.1.x は Jakarta EE 10 対応に伴いサーブレット/JSP エンジン（CatalinaやJasper）内部も更新されています。TomcatにバンドルされるAPIライブラリもJakarta版に置き換わっています（例：Tomcat 9では *servlet-api.jar*（Servlet 4.0、javax）を提供していましたが、Tomcat 10では *servlet-api.jar* 内のクラスが Servlet 6.0、jakarta パッケージに変わっています）。また認証・認可も Jakarta標準の **Jakarta Authentication 3.0**（旧称 JASPIC 1.1 相当）に更新されています。

### サーバ設定・構成の変更点

* **AJP コネクタ設定のデフォルト変更**: Tomcat 9.0.31 以降、AJP/1.3 コネクタにセキュリティ強化のための変更が入りました（詳細は後述の「AJP設定項目の変更点」セクション参照）。**デフォルトで AJP コネクタがループバックアドレスでのみ待ち受ける**ようになり、かつ**secret（共有シークレット）が未設定のままでは起動しない**挙動に変わっています。Tomcat 10.1.x でもこの方針が踏襲されており、適切な設定なしではAJPコネクタは動作しません。したがって、**Apache httpd（mod\_jk/mod\_proxy\_ajp）経由での連携を行う場合、Tomcat側およびApache側双方でAJPの共有シークレットや接続先アドレスの設定を明示する必要があります**。

* **APR/ネイティブコネクタの非推奨化**: Tomcat 9系では選択オプションとしてAPRベースのネイティブコネクタ（Apache Portable Runtime による高速実装）を使用可能でしたが、Tomcat 10.1では従来のAPRコネクタは**サポートされなくなりました**。Tomcatドキュメントでも10.1版では **AJPコネクタの実装としてNIO/NIO2のみが記載**され、9.0版で触れられていたAPRは言及されていません。今後は標準のNIOベースコネクタにTomcat Nativeライブラリ（tcnative 2.x）を組み合わせてOpenSSLを利用する形で性能向上や機能拡張を図る形となります。APR特有の設定項目（例えば `opensslCipherSuite` などAPR専用属性）は移行後は適用できないため注意が必要です。

* **その他デフォルト設定の変更**: Tomcat 9→10 にかけて**いくつかの既定値が変更**されています。例えば:

  * クッキー処理：Tomcat 9では既に**RFC 6265準拠のCookieProcessor**がデフォルトでしたが、Tomcat 10でも引き続きRFC準拠実装が使われます（変更なし）。
  * Managerアプリ等のアクセス制限：Tomcat 9では Manager/Host Manager アプリに対しデフォルトで `RemoteAddrValve` により `localhost` 限定アクセスとなっていました。Tomcat 10でも同様にデフォルトで管理系アプリへのリモートアクセスは遮断されています（server.xmlにValve定義あり）。
  * ログ保存期間：Tomcat 9.0.55以降、ローテーションされたログファイルを**90日間保持後に削除**するのが既定となりました。Tomcat 10.1でもこの設定は引き継がれています。
  * セッション複製関連：Tomcat 10では Javaシリアライズに依存しないセッション管理など内部実装が強化されていますが、基本的な設定項目に大きな差異はありません。

* **新機能と拡張**: Tomcat 10.1 では Jakarta EE10対応に伴う仕様拡張のほか、いくつかの新機能強化があります。

  * **Servlet 6.0**: サーブレット仕様そのものの拡張は限定的ですが、一部非推奨APIの削除や、新HTTPメソッドへの対応など細かな改善が含まれます（例：`HttpServletRequest::isTrailerFieldsReady` 等、HTTP/2のTrailerサポート追加）。
  * **AOT/GraalVM 対応**: Tomcat 10.1 ドキュメントには**GraalVMによるAhead-of-Timeコンパイル（ネイティブイメージ）対応**に関する記述が追加されています。Tomcatコアコンポーネントの一部がAOT対応され、ネイティブイメージでの動作が容易になるよう配慮されています。
  * **その他**: WebSocket 2.1やEL 5.0といった Jakarta EE10準拠APIの新機能が利用可能です。例えば WebSocket 2.1 では `WebSocketContainer#getDefaultProvider()` が追加されるなどの拡張があります。これらはTomcatの設定ファイルには直接現れませんが、プラットフォーム全体の機能強化として認識しておくべき点です。

## 2. デフォルト値が変更された主なパラメータ一覧

Tomcat 9.0.x系から10.1.x系への移行に際し、**既定値（デフォルト設定値）が変更された代表的な設定項目**を以下にまとめます。

* **AJP コネクタ関連**:

  * `address` – **AJPの待ち受けアドレス**のデフォルトが変更されています。Tomcat 9.0.30までは明示しない場合すべてのインターフェースで待ち受けましたが、9.0.31以降（Tomcat 10含む）**デフォルトはループバックアドレス（localhost）のみにバインド**となりました。
  * `secretRequired` – **AJPコネクタの共有シークレット必須化フラグ**。9.0.31で追加され、デフォルトが `true`（有効）に変更されました。従来はシークレット認証なしでAJP接続を許可していましたが、現在は**デフォルトでシークレット未設定だとコネクタ起動自体が失敗**します。
  * `secret` – **AJP接続シークレット文字列**。9.0.31で導入。既定値は `null`（未設定）です。`secretRequired="true"` がデフォルトのため、実質的に**ユーザが適切なシークレット値を設定することが必須**となっています。
  * `allowedRequestAttributesPattern` – **AJP経由で許可するリクエスト属性名のパターン**。9.0.31で導入され、**デフォルト値は `null`（= 任意の属性は許可しないことを意味）**です。従来は mod\_jk 等から任意のリクエスト属性を Tomcat に渡せましたが、セキュリティ上の観点から現在は**既知の属性以外は全て拒否（403エラー）する挙動がデフォルト**になっています。必要に応じて正規表現で許可したい属性名パターンを設定できます。

* **コネクタ全般/HTTP**:

  * `maxThreads` – **コネクタのワーカースレッド数上限**。Tomcat 9/10とも既定値は 200 ですが、Servlet 4.0→6.0への仕様変更で非同期リクエストの扱いが変化したこともあり、スレッドプール設定の適正化がより重要となります（Tomcat 9でもServlet 3.0以降非同期リクエスト数に応じた調整が推奨されていました）。移行時に現在のトラフィックに照らして適切なスレッド数を再評価するとよいでしょう。
  * `maxConnections` – **同時接続数上限**。Tomcat 9/10共にデフォルト 8192 です（NIOコネクタでは `-1` 指定で無制限化も可能）。大規模環境で必要なら調整しますが、一般には既定値で十分です。
  * `connectionTimeout` – **接続待ちタイムアウト**。HTTPコネクタではデフォルト 20秒（20000ミリ秒）ですが、\*\*AJPコネクタの場合デフォルトは -1（無制限）\*\*です。AJPでは接続確立後のリクエスト受信を無期限に待つ既定挙動となっており、Tomcat 10でも同様です。
  * `keepAliveTimeout` – **長押し接続維持タイムアウト**。Tomcat 9.0.27以降 HTTPコネクタでは `connectionTimeout` と同値がデフォルトとなりましたが、AJPコネクタでは引き続き **`connectionTimeout`（デフォルト -1）の値を流用**します。すなわち Tomcat 10でもAJP接続はクライアント（ここではApache HTTPD）が明示的に切断しない限り永続化されます。

* **セキュリティ関連**:

  * `CookieProcessor` – 前述の通り**RFC6265準拠**がデフォルトで、Tomcat 9→10間で変更はありません。特定のレガシー挙動（RFC準拠外の古いCookie仕様）を必要とする場合は `<CookieProcessor className="LegacyCookieProcessor">` を設定する必要があります。
  * セッション管理関連のパラメータ（`sessionTimeout` 等）は Jakarta EE仕様上は変わっていません。ただし Tomcat 10では内部で jakarta.servlet.http.HttpSession 実装が刷新されており、Javaシリアライズに依存しないセッション複製が可能になるなどの変更があります。設定項目自体のデフォルトは従来どおりです。
  * デプロイメント記述子（web.xml）の名前空間URIは Jakarta EE版に変更されています。Tomcat 10のデフォルト組み込みweb.xmlも Jakarta EE 10用のスキーマURLを使用しています（例：`xmlns="https://jakarta.ee/xml/ns/jakartaee"` 等）。これら**XML名前空間URIやスキーマ定義の変更**は、移行時にカスタムweb.xmlやcontext.xmlを持つアプリケーションで注意が必要です。

## 3. AJP/1.3 プロトコルの設定パラメータ詳細（セキュリティ・性能面の変遷）

Apache httpd（mod\_jk または mod\_proxy\_ajp）との連携に用いられる **AJP/1.3 コネクタ**周りの主要な設定項目について、Tomcat 9.0.x から 10.1.x にかけての**有無・デフォルト値・推奨値の変遷**を整理します。セキュリティ強化策とパフォーマンスチューニングに関連するパラメータを中心に説明します。

* **`address`（バインドアドレス）**: AJPコネクタが待ち受けるネットワークインターフェイスを指定する属性です。Tomcat 9.0.31以降この属性を指定しない場合のデフォルトは**ループバックアドレス**（IPv4なら127.0.0.1、IPv6なら ::1）となりました。したがって標準設定では **TomcatはlocalhostからのAJP接続のみ受け付ける**状態になります。外部ホスト上のApache HTTP Serverから接続する場合、`address="0.0.0.0"`（全インターフェイス）または特定のIPを明示指定する必要があります。セキュリティ面では可能な限りループバックに限定し、TomcatとApacheを同一ホスト内で連携させる構成が推奨されます。

* **`secretRequired` および `secret`（共有シークレット認証）**: 前述のとおり、Tomcat 9.0.31で AJPコネクタに `secretRequired` 属性が追加されデフォルト有効化されました。**デフォルト設定では `secret` 属性に値が設定されていない限り AJPコネクタは起動しません】**。移行後のTomcat 10.1.xでもこの挙動は同じです。したがってApache側（mod\_jkの場合はworkers.properties、mod\_proxy\_ajpの場合はProxyPass設定など）でも**Tomcatと一致するシークレット文字列を設定**しなければ接続できなくなります。`secret` の既定値は `null`（未設定）であり、**運用環境では推測困難なランダム文字列を設定することが推奨**されます。なお、ファイアウォール等でTomcatサーバ自体が信頼できるネットワーク内に厳重に保護されている場合に限り、`secretRequired="false"` を明示設定してシークレット認証を無効化する運用も考えられますが、**公式にはセキュリティ上このフラグをfalseにするのは最小限に留めるよう警告**されています。

* **`allowedRequestAttributesPattern`（許可リクエスト属性名パターン）**: こちらもTomcat 9.0.31で追加された重要なセキュリティパラメータです。AJPプロトコルでは、Apache側からTomcatに対しリクエスト属性（`javax.servlet.*` や `AJP_*` で始まる内部情報）を渡すことができます。デフォルトではTomcatに予め認識された属性（SSL情報やクライアント証明書、ロードバランサ情報等）以外はすべて拒否されます。その実現のため、`allowedRequestAttributesPattern` のデフォルト値は `null` となっており、\*\*「正規表現が未指定の場合は任意の属性を認めない」=“不明な属性は403エラーでブロック”\*\*という挙動になります。\*\*Ghostcat脆弱性（CVE-2020-1938）\*\*への対策として導入されたもので、Tomcat 10.1.xでもデフォルト設定で同様の保護がかかっています。通常、この値は変更せずデフォルト（null）のままとし、どうしても特定のカスタム属性を許可する必要がある場合にのみ適切な正規表現を指定するようにします。例えば mod\_jk の `JkEnvVar` 機能等で独自属性を渡していたケースでは、その属性名を許可するパターンを明示的に設定する必要があります。

* **`tomcatAuthentication` / `tomcatAuthorization`（認証・認可の委譲設定）**: これらはApache httpd 側で認証を行い Tomcatにユーザ情報を引き継ぐ場合の設定です。

  * `tomcatAuthentication` は **Tomcat側で認証を実施するか**を制御し、デフォルトは `true`（Tomcatが認証主体）です。Apache httpd 上で例えば `mod_auth` 等によりユーザ認証済みの場合、Tomcatにそのままユーザ名を渡したいことがあります。その際は **Tomcat側で再認証しないよう `tomcatAuthentication="false"` を設定**し、Apacheから `REMOTE_USER` 属性経由でユーザ名を受け取れるようにします。これにより AJPプロトコルで伝達されたユーザ情報を Tomcat が信頼して利用します。一方、このフラグをfalseにした場合、**認証自体はApache任せになるためTomcat側では認証クレデンシャルの検証は行いません**。
  * `tomcatAuthorization` は **Apache側で認証されたユーザに対し、Tomcat側でウェブアプリケーションのロールベース認可を適用するか**を決めるフラグで、デフォルトは `false` です。例えばウェブアプリケーションの`web.xml`にセキュリティ制約（<security-constraint>）が定義されロールによるアクセス制御をしている場合、Tomcatは通常そのロールマッピングに従った**認可チェックを行います**。`tomcatAuthorization="true"` を設定すると、Apacheから渡されたユーザに対して**Tomcatが保持するRealm（ユーザデータベース）でロール情報を照合し、アプリケーションのアクセス制御を実施**します。デフォルトfalseでは、TomcatはApacheから渡されたユーザ名に対し認可処理を行わず、そのユーザにはロールが付与されないものとして扱います。シングルサインオン構成などで**Apache側で認証だけ行い、認可（ロールチェック）はアプリケーション側で行いたい場合**には、このフラグをtrueに設定します。もっとも、Apache側で認可も完結させる場合はTomcat側で特にロールチェックさせる必要はないため、その場合はデフォルトfalseのままとします。

* **パフォーマンス関連のパラメータ**:

  * **スレッドプール設定**: 前述のとおり `maxThreads`（最大スレッド数）既定値は200、`minSpareThreads`（最小待機スレッド数）既定値は10です。AJP連携時にはApache側モジュールでも並列リクエスト数の設定が関与します。例えば **mod\_jkの場合、`worker.properties`の `worker.<name>.connections`（接続プールサイズ）やApacheのMaxRequestWorkersとのバランス**を考慮し、Tomcatのスレッド数と矛盾がないように調整します。Tomcat側で過剰にスレッド数を増やしすぎるとコンテキストスイッチによるオーバーヘッドが増えるため、想定同時リクエスト数に応じ適切に設定します（スレッド数=Apache側からの同時接続本数程度が目安）。なお、Tomcat内部ではProcessorオブジェクトのキャッシュ (`processorCache`、デフォルト200) によりスレッド再利用のオーバーヘッド削減が図られています。極端に高並列な環境でなければ既定値のままで問題ありません。
  * **コネクション関連**: AJPは**キープアライブ**（コネクションの持続）を前提としており、Tomcat側では `connectionTimeout=-1`/`keepAliveTimeout`無指定（実質無制限）で**接続を張りっぱなし**にします。Apache側でも `maxReuse` や KeepAliveTimeout の設定によってコネクションを再利用するため、**通常は長時間アイドルでない限りAJP接続は切断・再確立せずに使い回されます**。これによりTLSハンドシェイク等のオーバーヘッドがなく高速になります。ただしファイアウォールのアイドルタイムアウト等でコネクションが切断されるケースもあるため、必要に応じて`keepAliveTimeout`を明示設定し一定時間（例:60秒）で切る運用も考えられます。`maxConnections`（最大同時接続数）はデフォルト8192接続と非常に大きく設定されていますが、これは**Apache側との接続プール上限より十分大きければよく**、特別な理由がなければ既定値のままで問題ありません。逆にTomcat側のmaxConnectionsを絞りすぎると、Apacheからの接続要求が詰まる恐れがありますので注意します。
  * **パケットサイズ**: AJPプロトコルの1リクエストあたり最大パケットサイズは `packetSize` 属性で指定し、デフォルト **8192バイト (8KB)** です。通常このサイズで問題ありませんが、**クライアント証明書をクッキー経由で転送するような場合や、HTTPヘッダが非常に長い場合**に8KBでは不足するケースがあります。その際はTomcat側 `packetSize` と Apache側（mod\_jk の `MaxPacketSize` や mod\_proxy\_ajp の設定）を双方同じ値に増やす必要があります（AJPはいずれか一方でも小さいとそれに合わせられてしまうため）。Tomcatでは最大 65536 バイト (64KB) まで指定可能です。なお 8192未満を設定した場合は自動的に8192に切り上げられます。
  * **フラッシュパケット (`ajpFlush`)**: Tomcatはアプリケーションが `ServletOutputStream.flush()` 等を呼び出した際に、**フロントのApacheにflushを通知するAJPメッセージ**を送ります。この挙動を制御するのが `ajpFlush` 属性で、デフォルトは `true`（flush時に明示フラッシュパケット送信）です。`true`の場合、Tomcatは**長いレスポンスの途中でも逐次Apache側にデータを送りクライアントに転送させます**。`false`に変更すると小刻みなflush送出を抑制できますが、その分**Apache側バッファにデータが溜まりやすくなり、クライアントへのレスポンスが一時的に遅延する可能性**があります。一般には既定値のまま `true` を推奨しますが、LAN内の高速通信かつ大量のflushが発生する特殊なケースでは、パケット数削減のためにfalseにする調整もあり得ます。
  * **TCPオプション**: AJPコネクタは内部的にはTCPソケット通信のため、`tcpNoDelay`（Nagleアルゴリズム無効化）や`soKeepAlive` 等の低レベル設定があります。`tcpNoDelay` はデフォルト `true`（Nagleオフ）となっており、小さなパケットでも遅延なく即時送出する挙動です。通常このままで良く、変更は不要です。また `soKeepAlive` (SO\_KEEPALIVE)、`soReuseAddress` などはJVM既定値に従います。これらをチューニングする必要は通常ありませんが、例えばファイアウォール越し環境でアイドル接続切断を防ぐためにKeepAliveを有効化する、といった場合に設定を検討します。もっとも、KeepAliveパケット送出間隔はOS/JVM依存となるため、Tomcat側での微調整は限定的です。

以上、Tomcat 9.0.93 から 10.1.41 への主な変更点と設定パラメータの差異を整理しました。公式ドキュメントおよびリリースノートに基づき、特にセキュリティ強化策（AJP周りの制限強化）と環境変化（Jakarta EE対応、Java要件変更）に留意して移行計画を進めてください。設定ファイルの差分についてはTomcat公式サイトの比較ツールも活用し、現行設定との違いを一つ一つ確認することを推奨いたします。
